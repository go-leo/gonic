# gors

gors（Golang Restful service）可以生成Go语言的Restful服务。
在grpc上，标注特殊的注解，可以生成Gin路由。


# 快速开始
## 1. 安装
如果通过grpc生成Restful服务，需要安装protoc-gen-go-gors：
```
go install github.com/go-leo/gors/cmd/protoc-gen-go-gors@latest
```

## 2. 定义Restful服务
或者通过grpc定义接口：
```proto
syntax = "proto3";
package protoservice;
option go_package = "github.com/go-leo/gors/example/api/protoservice;protoservice";

// @GORS @Path(/v1)
service ProtoService {
  // @GORS @POST @Path(/Method) @ProtoJSONBinding @ProtoJSONRender
  rpc Method (HelloRequest) returns (HelloReply) {}
}

message HelloRequest {
  string name = 1;
  int32 age = 2;
  double salary = 3;
  string Token = 4;
}

message HelloReply {
  string message = 1;
}

```


## 3. 生成gin路由代码
通过protocolbuf生成，运行一下命令，生产文件service_gors.go
```
protoc \
		--proto_path=. \
		--go_out=. \
		--go_opt=module=github.com/go-leo/gors \
		--go-grpc_out=. \
		--go-grpc_opt=module=github.com/go-leo/gors \
		--go-gors_out=. \
		--go-gors_opt=module=github.com/go-leo/gors \
		example/api/*/*.proto
```
生产文件service_gors.go
```go
// Code generated by protoc-gen-go-gors. DO NOT EDIT.
package protoservice

import (
	gin "github.com/gin-gonic/gin"
	gors "github.com/go-leo/gors"
	grpc "google.golang.org/grpc"
	metadata "google.golang.org/grpc/metadata"
	http "net/http"
)

func ProtoServiceClientRoutes(cli ProtoServiceClient, opts ...gors.Option) []gors.Route {
	options := gors.New(opts...)
	_ = options
	if len(options.Tag) == 0 {
		options.Tag = "json"
	}
	return []gors.Route{
		gors.NewRoute(
			http.MethodPost,
			"/v1/Method",
			func(c *gin.Context) {
				var rpcMethodName = "/protoservice.ProtoService/Method"
				var ctx = gors.NewContext(c, rpcMethodName)
				var req *HelloRequest
				var resp *HelloReply
				var err error
				req = new(HelloRequest)
				if err = gors.RequestBind(
					ctx, req, options.Tag,
					gors.ProtoJSONBinding,
				); err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				if ctx, err = gors.NewGRPCContext(ctx, options.IncomingHeaderMatcher, options.MetadataAnnotators); err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				var headerMD, trailerMD metadata.MD
				resp, err = cli.Method(ctx, req, grpc.Header(&headerMD), grpc.Trailer(&trailerMD))
				gors.AddGRPCMetadata(ctx, headerMD, trailerMD, options.OutgoingHeaderMatcher)
				if err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				gors.ResponseRender(ctx, gors.StatusCode(ctx), resp, "", gors.ProtoJSONRender, options.ResponseWrapper)
			},
		),
	}
}

func ProtoServiceServerRoutes(srv ProtoServiceServer, opts ...gors.Option) []gors.Route {
	options := gors.New(opts...)
	_ = options
	if len(options.Tag) == 0 {
		options.Tag = "json"
	}
	return []gors.Route{
		gors.NewRoute(
			http.MethodPost,
			"/v1/Method",
			func(c *gin.Context) {
				var rpcMethodName = "/protoservice.ProtoService/Method"
				var ctx = gors.NewContext(c, rpcMethodName)
				var req *HelloRequest
				var resp *HelloReply
				var err error
				req = new(HelloRequest)
				if err = gors.RequestBind(
					ctx, req, options.Tag,
					gors.ProtoJSONBinding,
				); err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				if ctx, err = gors.NewGRPCContext(ctx, options.IncomingHeaderMatcher, options.MetadataAnnotators); err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				stream := gors.NewServerTransportStream(rpcMethodName)
				ctx = grpc.NewContextWithServerTransportStream(ctx, stream)
				resp, err = srv.Method(ctx, req)
				gors.AddGRPCMetadata(ctx, stream.Header(), stream.Trailer(), options.OutgoingHeaderMatcher)
				if err != nil {
					gors.ErrorRender(ctx, err, options.ErrorHandler, options.ResponseWrapper)
					return
				}
				gors.ResponseRender(ctx, gors.StatusCode(ctx), resp, "", gors.ProtoJSONRender, options.ResponseWrapper)
			},
		),
	}
}

```

## 4. 实现服务
通过grpc定义接口：
```go
package svc

import (
	"context"
	"github.com/go-leo/gors/example/api/protoservice"
)

var _ protoservice.ProtoServiceServer = new(ProtoService)

type ProtoService struct {
	protoservice.UnimplementedProtoServiceServer
}

func (p ProtoService) Method(ctx context.Context, request *protoservice.HelloRequest) (*protoservice.HelloReply, error) {
	return &protoservice.HelloReply{Message: "hi " + request.GetName()}, nil
}


```

## 5. 启动服务
通过grpc定义接口有通过client和server两种启动方式

server方式：
```go
package main

import (
	"github.com/go-leo/gors/example/api/protodemo"
	"github.com/go-leo/gors/example/internal/app/api/svc"
	"net"
	"net/http"

	"github.com/gin-gonic/gin"

	"github.com/go-leo/gors"
)

func main() {
	engine := gin.New()
	engine = gors.AppendRoutes(engine, protodemo.ProtoDemoServerRoutes(new(svc.HelloWorldService))...)
	srv := http.Server{Handler: engine}
	listen, err := net.Listen("tcp", ":8088")
	if err != nil {
		panic(err)
	}
	err = srv.Serve(listen)
	if err != nil {
		panic(err)
	}
}
```

client方式：
```go
package main

import (
	"github.com/go-leo/gors/example/api/protodemo"
	"github.com/go-leo/gors/example/internal/app/api/svc"
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
	"net"
	"net/http"
	"time"

	"github.com/gin-gonic/gin"

	"github.com/go-leo/gors"
)

func main() {
	go func() {
		server := grpc.NewServer()
		protodemo.RegisterProtoDemoServer(server, new(svc.ProtoDemoServer))
		listen, err := net.Listen("tcp", ":9090")
		if err != nil {
			panic(err)
		}
		err = server.Serve(listen)
		if err != nil {
			panic(err)
		}
	}()

	time.Sleep(time.Second)
	dial, err := grpc.Dial(":9090", grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		panic(err)
	}
	client := protodemo.NewProtoDemoClient(dial)

	engine := gin.New()
	engine = gors.AppendRoutes(engine, protodemo.ProtoDemoClientRoutes(client)...)
	srv := http.Server{Handler: engine}
	listen, err := net.Listen("tcp", ":8088")
	if err != nil {
		panic(err)
	}
	err = srv.Serve(listen)
	if err != nil {
		panic(err)
	}
}
```

# 注解大全
[注解大全](README_comments.MD)

# 例子
[protodemo](example%2Fapi%2Fprotodemo)